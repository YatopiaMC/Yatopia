From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: JellySquid <jellysquid+atwork@protonmail.com>
Date: Fri, 23 Oct 2020 18:46:33 -0500
Subject: [PATCH] lithium ScaleLayer CachingLayerContext

Original code by JellySquid, licensed under LGPLv3
you can find the original code on https://github.com/jellysquid3/lithium-fabric/ (Yarn mappings)

diff --git a/src/main/java/me/jellysquid/mods/lithium/common/world/layer/CachingLayerContextExtended.java b/src/main/java/me/jellysquid/mods/lithium/common/world/layer/CachingLayerContextExtended.java
new file mode 100644
index 0000000000000000000000000000000000000000..d1932a66fa30bd80f29933ac23670e7d26dbefef
--- /dev/null
+++ b/src/main/java/me/jellysquid/mods/lithium/common/world/layer/CachingLayerContextExtended.java
@@ -0,0 +1,10 @@
+package me.jellysquid.mods.lithium.common.world.layer;
+
+public interface CachingLayerContextExtended {
+
+    /**
+     * Scrambles the local seed of the layer without calling an expensive floorMod, simulating a nextInt call with
+     * less overhead.
+     */
+    void skipInt();
+}
diff --git a/src/main/java/net/minecraft/server/GenLayerZoom.java b/src/main/java/net/minecraft/server/GenLayerZoom.java
index 08e85d98a5cdd017b6f4de588c93de7aa45ef1e1..62e5c94b198bd21c061e021d0c58df8d377396ef 100644
--- a/src/main/java/net/minecraft/server/GenLayerZoom.java
+++ b/src/main/java/net/minecraft/server/GenLayerZoom.java
@@ -1,5 +1,7 @@
 package net.minecraft.server;
 
+import me.jellysquid.mods.lithium.common.world.layer.CachingLayerContextExtended;
+
 public enum GenLayerZoom implements AreaTransformer2 {
 
     NORMAL, FUZZY {
@@ -21,7 +23,8 @@ public enum GenLayerZoom implements AreaTransformer2 {
         return i >> 1;
     }
 
-    @Override
+    // Yatopia Replace Logic
+    /*
     public int a(AreaContextTransformed<?> areacontexttransformed, Area area, int i, int j) {
         int k = area.a(this.a(i), this.b(j));
 
@@ -50,6 +53,42 @@ public enum GenLayerZoom implements AreaTransformer2 {
                 }
             }
         }
+     */
+    @Override
+    public int a(AreaContextTransformed<?> ctx, Area parent, int x, int z) {
+        // [VanillaCopy] ScaleLayer#sample
+
+        int tl = parent.a(this.a(x), this.b(z));
+        int ix = x & 1;
+        int iz = z & 1;
+
+        if (ix == 0 && iz == 0) {
+            return tl;
+        }
+
+        ctx.a(x & ~1, z & ~1);
+
+        if (ix == 0) {
+            int bl = parent.a(this.a(x), this.b(z + 1));
+            return ctx.a(tl, bl);
+        }
+
+        // move `choose` into above if-statement: maintain rng parity
+        ((CachingLayerContextExtended) ctx).skipInt();
+
+        if (iz == 0) {
+            int tr = parent.a(this.a(x + 1), this.b(z));
+            return ctx.a(tl, tr);
+        }
+
+        // move `choose` into above if-statement: maintain rng parity
+        ((CachingLayerContextExtended) ctx).skipInt();
+
+        int bl = parent.a(this.a(x), this.b(z + 1));
+        int tr = parent.a(this.a(x + 1), this.b(z));
+        int br = parent.a(this.a(x + 1), this.b(z + 1));
+
+        return this.a(ctx, tl, tr, bl, br);
     }
 
     protected int a(AreaContextTransformed<?> areacontexttransformed, int i, int j, int k, int l) {
diff --git a/src/main/java/net/minecraft/server/WorldGenContextArea.java b/src/main/java/net/minecraft/server/WorldGenContextArea.java
index b67d88d32a73b3a51809b91db11d54bc99169fe1..06a1b61635423d83a7e52f112f724a69e5ee2cad 100644
--- a/src/main/java/net/minecraft/server/WorldGenContextArea.java
+++ b/src/main/java/net/minecraft/server/WorldGenContextArea.java
@@ -1,9 +1,11 @@
 package net.minecraft.server;
 
 import it.unimi.dsi.fastutil.longs.Long2IntLinkedOpenHashMap;
+import me.jellysquid.mods.lithium.common.world.layer.CachingLayerContextExtended;
+
 import java.util.Random;
 
-public class WorldGenContextArea implements AreaContextTransformed<AreaLazy> {
+public class WorldGenContextArea implements AreaContextTransformed<AreaLazy>, CachingLayerContextExtended { // Yatopia
 
     private final Long2IntLinkedOpenHashMap a;
     private final int b;
@@ -67,4 +69,9 @@ public class WorldGenContextArea implements AreaContextTransformed<AreaLazy> {
         l = LinearCongruentialGenerator.a(l, k);
         return l;
     }
+
+    @Override
+    public void skipInt() {
+        this.e = LinearCongruentialGenerator.a(this.e, this.d);
+    } // Yatopia
 }
