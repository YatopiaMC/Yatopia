From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: JellySquid <jellysquid+atwork@protonmail.com>
Date: Fri, 23 Oct 2020 18:46:33 -0500
Subject: [PATCH] lithium ScaleLayer CachingLayerContext

Original code by JellySquid, licensed under LGPLv3
you can find the original code on https://github.com/jellysquid3/lithium-fabric/ (Yarn mappings)

diff --git a/src/main/java/me/jellysquid/mods/lithium/common/world/layer/CachingLayerContextExtended.java b/src/main/java/me/jellysquid/mods/lithium/common/world/layer/CachingLayerContextExtended.java
new file mode 100644
index 0000000000000000000000000000000000000000..d1932a66fa30bd80f29933ac23670e7d26dbefef
--- /dev/null
+++ b/src/main/java/me/jellysquid/mods/lithium/common/world/layer/CachingLayerContextExtended.java
@@ -0,0 +1,10 @@
+package me.jellysquid.mods.lithium.common.world.layer;
+
+public interface CachingLayerContextExtended {
+
+    /**
+     * Scrambles the local seed of the layer without calling an expensive floorMod, simulating a nextInt call with
+     * less overhead.
+     */
+    void skipInt();
+}
diff --git a/src/main/java/net/minecraft/server/GenLayerZoom.java b/src/main/java/net/minecraft/server/GenLayerZoom.java
index 08e85d98a5cdd017b6f4de588c93de7aa45ef1e1..73417affd8b09c82ecabde0889a57486c14ca211 100644
--- a/src/main/java/net/minecraft/server/GenLayerZoom.java
+++ b/src/main/java/net/minecraft/server/GenLayerZoom.java
@@ -23,6 +23,8 @@ public enum GenLayerZoom implements AreaTransformer2 {
 
     @Override
     public int a(AreaContextTransformed<?> areacontexttransformed, Area area, int i, int j) {
+        // Yatopia start - replaced logic
+        /*
         int k = area.a(this.a(i), this.b(j));
 
         areacontexttransformed.a((long) (i >> 1 << 1), (long) (j >> 1 << 1));
@@ -50,6 +52,41 @@ public enum GenLayerZoom implements AreaTransformer2 {
                 }
             }
         }
+         */
+        // [VanillaCopy] ScaleLayer#sample
+
+        int tl = area.a(this.a(i), this.b(j));
+        int ix = i & 1;
+        int iz = j & 1;
+
+        if (ix == 0 && iz == 0) {
+            return tl;
+        }
+
+        areacontexttransformed.a(i & ~1, j & ~1);
+
+        if (ix == 0) {
+            int bl = area.a(this.a(i), this.b(j + 1));
+            return areacontexttransformed.a(tl, bl);
+        }
+
+        // move `choose` into above if-statement: maintain rng parity
+        ((me.jellysquid.mods.lithium.common.world.layer.CachingLayerContextExtended) areacontexttransformed).skipInt();
+
+        if (iz == 0) {
+            int tr = area.a(this.a(i + 1), this.b(j));
+            return areacontexttransformed.a(tl, tr);
+        }
+
+        // move `choose` into above if-statement: maintain rng parity
+        ((me.jellysquid.mods.lithium.common.world.layer.CachingLayerContextExtended) areacontexttransformed).skipInt();
+
+        int bl = area.a(this.a(i), this.b(j + 1));
+        int tr = area.a(this.a(i + 1), this.b(j));
+        int br = area.a(this.a(i + 1), this.b(j + 1));
+
+        return this.a(areacontexttransformed, tl, tr, bl, br);
+        // Yatopia end
     }
 
     protected int a(AreaContextTransformed<?> areacontexttransformed, int i, int j, int k, int l) {
diff --git a/src/main/java/net/minecraft/server/WorldGenContextArea.java b/src/main/java/net/minecraft/server/WorldGenContextArea.java
index b67d88d32a73b3a51809b91db11d54bc99169fe1..d5a373692a0c167a83c2c61d94c6ab85d9678e13 100644
--- a/src/main/java/net/minecraft/server/WorldGenContextArea.java
+++ b/src/main/java/net/minecraft/server/WorldGenContextArea.java
@@ -3,7 +3,7 @@ package net.minecraft.server;
 import it.unimi.dsi.fastutil.longs.Long2IntLinkedOpenHashMap;
 import java.util.Random;
 
-public class WorldGenContextArea implements AreaContextTransformed<AreaLazy> {
+public class WorldGenContextArea implements AreaContextTransformed<AreaLazy>, me.jellysquid.mods.lithium.common.world.layer.CachingLayerContextExtended { // Yatopia
 
     private final Long2IntLinkedOpenHashMap a;
     private final int b;
@@ -67,4 +67,6 @@ public class WorldGenContextArea implements AreaContextTransformed<AreaLazy> {
         l = LinearCongruentialGenerator.a(l, k);
         return l;
     }
+
+    @Override public void skipInt() { this.e = LinearCongruentialGenerator.a(this.e, this.d); } // Yatopia
 }
