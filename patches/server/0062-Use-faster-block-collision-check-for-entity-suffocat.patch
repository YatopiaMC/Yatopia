From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mykyta Komarn <nkomarn@hotmail.com>
Date: Tue, 29 Sep 2020 17:27:30 -0700
Subject: [PATCH] Use faster block collision check for entity suffocation check

Improves the speed of checks by ~3,000ns per entity on average.

diff --git a/src/main/java/me/jellysquid/mods/lithium/common/entity/movement/ChunkAwareBlockCollisionSweeper.java b/src/main/java/me/jellysquid/mods/lithium/common/entity/movement/ChunkAwareBlockCollisionSweeper.java
index 7ed343cfb3130446c85dab2ca04d60f91e2c94fb..be4c925b733aabeb76557bfdc52b5fccbc35ad6e 100644
--- a/src/main/java/me/jellysquid/mods/lithium/common/entity/movement/ChunkAwareBlockCollisionSweeper.java
+++ b/src/main/java/me/jellysquid/mods/lithium/common/entity/movement/ChunkAwareBlockCollisionSweeper.java
@@ -16,6 +16,7 @@ import net.minecraft.server.VoxelShape;
 import net.minecraft.server.VoxelShapeCollision;
 import net.minecraft.server.VoxelShapes;
 
+import java.util.function.BiPredicate; // Yatopia
 import static me.jellysquid.mods.lithium.common.entity.LithiumEntityCollisions.EPSILON;
 
 /**
@@ -59,6 +60,15 @@ public class ChunkAwareBlockCollisionSweeper {
     private ChunkSection cachedChunkSection;
     private boolean needEntityCollisionCheck;
 
+    // Yatopia start
+    private final BiPredicate<IBlockData, BlockPosition> suffocationPredicate = new BiPredicate<IBlockData, BlockPosition>() {
+        @Override
+        public boolean test(IBlockData iBlockData, BlockPosition blockPosition) {
+            return iBlockData.o(view, blockPosition);
+        }
+    };
+    // Yatopia end
+
     public ChunkAwareBlockCollisionSweeper(ICollisionAccess view, Entity entity, AxisAlignedBB box) {
         this.box = box;
         this.shape = VoxelShapes.of(box);
@@ -206,6 +216,11 @@ public class ChunkAwareBlockCollisionSweeper {
 
             if (canInteractWithBlock(state, edgesHit)) {
                 this.pos.setValues(x, y, z);
+                // Yatopia start
+                if (!suffocationPredicate.test(state, this.pos)) {
+                    continue;
+                }
+                // Yatopia end
                 VoxelShape collisionShape = state.getCollisionShape(this.view, this.pos, this.context);
 
                 if (collisionShape != VoxelShapes.empty()) {
diff --git a/src/main/java/net/minecraft/server/Entity.java b/src/main/java/net/minecraft/server/Entity.java
index 9dfc5649b552a8cb16092fe6b20aa1c181b59d5e..8899e91674dcd7f8a586afe4be07799634585a69 100644
--- a/src/main/java/net/minecraft/server/Entity.java
+++ b/src/main/java/net/minecraft/server/Entity.java
@@ -2171,9 +2171,7 @@ public abstract class Entity implements INamableTileEntity, ICommandListener, Ke
             float f1 = this.size.width * 0.8F;
             AxisAlignedBB axisalignedbb = AxisAlignedBB.g((double) f1, 0.10000000149011612D, (double) f1).d(this.locX(), this.getHeadY(), this.locZ());
 
-            return this.world.b(this, axisalignedbb, (iblockdata, blockposition) -> {
-                return iblockdata.o(this.world, blockposition);
-            }).findAny().isPresent();
+            return new me.jellysquid.mods.lithium.common.entity.movement.ChunkAwareBlockCollisionSweeper(this.world, this, axisalignedbb).getNextCollidedShape() != null; // Yatopia - fast suffocation check
         }
     }
 
